<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pyodide in WebView</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.18.1/full/pyodide.js"></script>
</head>
<body>
  <script>
    async function loadPyodideAndRun() {
      let pyodide = await loadPyodide({
        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.18.1/full/"
      });

      // Ensure that micropip is available
      await pyodide.loadPackage('micropip');

      // Load and initialize your Python scripts using relative paths
      await pyodide.runPythonAsync(`
        import micropip
        await micropip.install('opencv-python-headless')

        import os
        os.chdir('/home/pyodide')  # Ensure the current directory is set

        # Paths of your Python scripts
        scripts = ["./poseDetectionDummy/Basics.py", "./poseDetectionDummy/PoseModule.py", "./poseDetectionDummy/TestProject.py"]

        # Load the scripts
        for script in scripts:
          with open(script, 'r') as file:
            code = file.read()
            exec(code)

        # Initialize the detector from the loaded scripts
        detector = poseDetector()
      `);

      // Function to process frame and return feedback and reps
      window.processFrame = async function(base64Image) {
        let result = await pyodide.runPythonAsync(`
          import cv2
          import numpy as np
          import base64

          # Decode base64 image
          img_data = base64.b64decode('${base64Image}')
          np_img = np.frombuffer(img_data, np.uint8)
          img = cv2.imdecode(np_img, cv2.IMREAD_COLOR)

          # Process the frame using your existing logic
          img = detector.findPose(img)
          lmList = detector.findPosition(img, draw=False)
          feedback = ""
          reps = 0

          if lmList:
            elbow = lmList[13] if 'left' else lmList[14]
            wrist = lmList[15] if 'left' else lmList[16]
            shoulder = lmList[11] if 'left' else lmList[12]

            # Check if the arm is fully extended
            if abs(elbow[1] - wrist[1]) > 80:
              feedback = "Fully extend your arm"
            elif wrist[1] > shoulder[1] + 80:
              feedback = "Raise your arm to the side"
            elif wrist[2] > shoulder[2] + 80:
              feedback = "Raise your arm higher"
            elif wrist[1] > shoulder[1] + 150:
              feedback = "Move arm left a bit"
            elif wrist[1] < shoulder[1] - 150:
              feedback = "Move arm right a bit"
            elif wrist[2] > shoulder[2] + 150:
              feedback = "Move arm up a bit"
            elif wrist[2] < shoulder[2] - 150:
              feedback = "Move arm down a bit"

            if feedback == "":
              if not raised_flag:
                raised_flag = True
              else:
                raised_flag = False
                reps += 1

          {"feedback": feedback, "reps": reps}
        `);
        return JSON.parse(result);
      };
    }
    loadPyodideAndRun();
  </script>
</body>
</html>
